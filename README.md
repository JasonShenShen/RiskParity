# 风险平价组合：变更与建议整理

## 目标与思路
- 用风险平价将黄金、30年国债、纳斯达克100、沪深300四类资产的风险贡献尽量相等，降低单一资产对组合的主导。
- 核心：用过去一段时间的收益计算协方差矩阵 Σ；求解等风险贡献权重，使每个资产的风险贡献 `w_i * (Σw)_i` 相近；定期（如每月）滚动更新。

## 算法要点
- 风险贡献：资产 i 的贡献为 `RC_i = w_i * (Σw)_i`，组合方差为 `wᵀΣw`。
- 等风险约束：令所有 `RC_i` 接近 `组合方差 / 资产数`，并满足 `w_i ≥ 0`、`∑w_i = 1`。
- 实现方法：以逆波动率归一为初值，通过迭代缩放权重让各 `RC_i` 收敛到目标；避免做空，每轮归一化到和为 1。

## 已落地脚本
- 文件：`risk_parity.py`
- 关键函数：
  - 等风险求解：`risk_parity.py:58` 的 `risk_parity_weights(sigma)`
  - 协方差计算：`risk_parity.py:34` 的 `_covariance_matrix(returns)`
  - 入口：`risk_parity.py:130` 的 `main()`
- 示例运行：
```
python3 risk_parity.py
```
- 示例输出（演示数据）：
```
{"weights": {"GLD": 0.0969, "TLT": 0.7948, "QQQ": 0.0466, "CSI300": 0.0617}}
```

## 用真实标的的配置建议
- 标的选择（可替换为实际可交易 ETF）：
  - 黄金：`GLD` 或境内黄金ETF（如 `518880`）
  - 长债：`TLT`（近似长端），或更久期的 `ZROZ/EDV`；境内可用 30年国债ETF
  - 纳指100：`QQQ`
  - 沪深300：`510300.SS`（雅虎 `.SS` 后缀）或美股中国A股ETF（如 `ASHR`）
- 数据与窗口：6–12 个月日度数据（常用 252 个交易日）；支持本地 CSV 或在线抓取。

## 接入自有价格数据
- 将四资产日度收盘价读入为二维数组 `returns`（每行是某日的四资产收益）：
  - `sigma = _covariance_matrix(returns)`（`risk_parity.py:34`）
  - `weights = risk_parity_weights(sigma)`（`risk_parity.py:58`）
- 可改为直接读取 `data/*.csv` 或接入行情库（如 yfinance）；当前脚本已接入 Yahoo CSV 下载。

## 定期更新与再平衡
- 更新频率：每月或每季；市场剧烈时提高频率需权衡成本。
- 触发阈值：某资产权重相对偏离目标超 20% 时再平衡，减少不必要交易。
- macOS 月度计划任务：
```
crontab -e
0 9 1 * * cd /Users/bytedance/sourcetree/RiskParity && /usr/bin/python3 risk_parity.py >> weights.log 2>&1
```

## 实务参数建议
- 窗口长度：252（日）较稳健；126（半年）更灵敏；504（两年）更平滑。
- 收益度量：对数收益或简单收益皆可，保持一致性。
- 约束：不做空（`w_i ≥ 0`）、满投（`∑w_i = 1`）；如需最大单资产上限（如 50%），可在求解中加入投影。
- 风险目标：基础等风险；可扩展为风险预算（如股票合计贡献 50%、债券 30%、黄金 20%）。

## 下一步
- 若提供具体 ETF 代码与数据源偏好（境内/境外），脚本将自动抓取真实行情、计算滚动协方差与权重，并输出每月再平衡文件。

---

## 对比与评估（外部实现）

### 总评
- 思路正确：以协方差衡量风险、用 SLSQP 最小化风险贡献差异并加约束，配合滚动窗口与月度再平衡。
- 建议补强协方差估计、约束设计、交易执行与鲁棒性以提升稳定性与可执行性。

### 主要优点
- 结构完整：数据抓取、权重优化、回测、可视化闭环管理。
- 约束合理：非负、权重和为 1、并设置 5%–50% 上下限抑制集中度。
- 风险贡献目标明确：采用“风险贡献占比相等”。
- 再平衡机制清晰：月度/季度与偏离触发式。

### 关键问题与改进点
- 协方差计算不一致：应统一为 `returns.tail(window).cov() * 252`，避免滚动协方差的复杂切片。
- 目标函数规范化：明确“等化的是方差贡献占比”，避免与“波动贡献”混淆。
- 数据质量：中国标的抓取不稳定；应使用 `Adj Close` 或本地 CSV，并增加重试/缓存。
- 数值稳定性：加入协方差收缩或对角线平滑，优化失败回退为逆波动率权重。
- 回测细节：早期缺数据不应以 0 代替；加入交易成本/滑点。
- 约束与周转：将下限调低（如 0–50%），引入周转惩罚（L1/L2）。

### 与当前实现的对比
- 当前仓库使用迭代 ERC 等化风险贡献（依赖少、稳健）；外部实现用 SLSQP（约束灵活、对协方差敏感）。
- 可结合：保留完整框架，同时将权重求解替换为迭代 ERC，并加入协方差收缩。

### 实操建议
- 统一协方差：`cov = returns.tail(lookback).cov() * 252`。
- 收益处理：用对数收益、`dropna(how='any')` 对齐资产。
- 协方差收缩：引入 `alpha`（如 0.1），对角线平滑。
- 约束与交易：阈值 + 定期再平衡、周转惩罚控制交易频率。
- 指标与可视化：用 `Adj Close`、报告中展示风险贡献与偏离建议。

---

## 已接入并运行（实际标的）
- 使用标的：`511090.SH`（30年国债ETF）、`512890.SH`（红利低波ETF）、`518880.SH`（黄金ETF）、`159659.SZ`（纳斯达克100ETF）。
- 抓取：从 Yahoo 下载历史 CSV（`Adj Close`），计算对数收益，取近一年（252 日）协方差，求风险平价权重。
- 运行命令：
```
python3 risk_parity.py --source yahoo --tickers 511090.SH 512890.SH 518880.SH 159659.SZ
```
- 示例输出（会随最新数据变化）：
```
{"weights": {"511090.SH": 0.2565, "512890.SH": 0.4450, "518880.SH": 0.1416, "159659.SZ": 0.1569}}
```

## 使用方法与定期更新
- 实时计算：运行上述命令即可按最新数据计算权重。
- 窗口长度：通过 `lookback_days`（默认 252）调整历史长度。
- 代码映射：沪市 `.SH` 自动映射为 Yahoo 的 `.SS`，深市 `.SZ` 保持不变。
- 月度计划任务：
```
0 9 1 * * cd /Users/bytedance/sourcetree/RiskParity && /usr/bin/python3 risk_parity.py --source yahoo --tickers 511090.SH 512890.SH 518880.SH 159659.SZ >> weights.log 2>&1
```
- 如需将输出保存为 `weights-YYYYMM.json` 用于调仓，我可直接改脚本实现。

## 实现细节
- 数据抓取：构造 Yahoo 历史 CSV 链接，读取 `Adj Close`。
- 日期对齐：对共同交易日取交集，避免缺值影响协方差。
- 风险平价：在 `risk_parity.py:58` 用迭代算法等化风险贡献，非负约束且权重归一化。
- 入口与抓取：命令行参数在 `risk_parity.py:130`；Yahoo 抓取与对齐在 `risk_parity.py:100–129`。

## 参数与注意事项
- 权重高不代表预期收益高；权重倾向分配到低波动、低相关的资产以平衡风险贡献。
- 可加入再平衡阈值（如相对偏差 20%）与“周转惩罚 + 交易成本”模块以贴近实盘。