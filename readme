目标与思路

- 用风险平价将黄金、30年国债、纳斯达克100、沪深300四类资产的风险贡献尽量相等，降低单一资产对组合的主导。
- 核心做法：用过去一段时间的收益计算协方差矩阵；求解等风险贡献权重，使每个资产的风险贡献 w_i * (Σw)_i 相近；定期（如每月）滚动更新。
算法要点

- 风险贡献：资产 i 的贡献为 RC_i = w_i * (Σw)_i ，组合方差为 wᵀΣw 。
- 等风险约束：令所有 RC_i 接近 组合方差 / 资产数 ，并满足 w_i ≥ 0 、 ∑w_i = 1 。
- 实现方法：以逆波动率归一为初值，通过迭代缩放权重让各 RC_i 收敛到目标；避免做空，每轮归一化到和为 1。
已为你落地的脚本

- 文件： risk_parity.py
- 关键函数：
  - 组合等风险求解在 risk_parity.py:58 的 risk_parity_weights(sigma) 。
  - 协方差计算在 risk_parity.py:34 的 _covariance_matrix(returns) 。
  - 示例运行入口在 risk_parity.py:130 的 main() 。
- 验证：已用合成数据运行并输出权重，终端展示如下（每次会略有变化）
  - 运行命令： python3 risk_parity.py
  - 输出示例： {"weights": {"GLD": 0.0969, "TLT": 0.7948, "QQQ": 0.0466, "CSI300": 0.0617}}
用真实标的的配置建议

- 标的选择（可替换为你实际可交易的 ETF）：
  - 黄金： GLD （美股）或境内黄金ETF（如 518880 ）。
  - 长债： TLT （20+年美债，近似长端），或更久期的 ZROZ/EDV ；境内可用 30年国债ETF。
  - 纳指100： QQQ 。
  - 沪深300： 510300.SS （雅虎行情为 .SS ）或美股中国A股ETF（如 ASHR ）。
- 数据获取与滚动窗口：
  - 建议滚动窗口 6–12 个月日度数据（常用 252 个交易日）。
  - 可将每日收盘价放到 data/ 目录下，每个资产一个 CSV（含 Date,Close ），或改造脚本接入行情抓取库。
如何接入你自己的价格数据

- 当前脚本默认用“合成数据”演示。你可以将真实价格序列读入、转换为日收益后代入 risk_parity_weights ：
  - 将你的四个资产日度收盘价读入为二维数组 returns （每行是某日四资产的收益），调用：
    - sigma = _covariance_matrix(returns) （ risk_parity.py:34 ）
    - weights = risk_parity_weights(sigma) （ risk_parity.py:58 ）
  - 若需要我帮你把脚本改为直接读取 data/*.csv 或接入行情库（例如 yfinance/pandas），告诉我你的偏好与可用环境，我会直接改好并验证运行。
定期更新与再平衡

- 更新频率：建议每月或每季；市场剧烈时可提高频率，但要权衡交易成本。
- 触发阈值：设置再平衡阈值，如某资产权重偏离目标超过 20% 相对偏差时再调整，减少不必要交易。
- 在本机按月自动运行（macOS）：
  - 编辑计划任务： crontab -e
  - 添加条目（每月 1 日 09:00 运行）： 0 9 1 * * cd /Users/bytedance/sourcetree/RiskParity && /usr/bin/python3 risk_parity.py >> weights.log 2>&1
  - weights.log 会累计每次的权重输出；也可改为写 JSON 文件，便于后续执行交易或报告。
实务参数建议

- 窗口长度：252 个交易日（约 12 个月）通常稳健；也可 126（半年）提高灵敏度。
- 收益度量：用对数收益或简单收益皆可；保持一致性即可。
- 约束：不做空（ w_i ≥ 0 ）、满投（ ∑w_i = 1 ）；如需加上最大单资产上限（如 50%），我可在求解中加入投影。
- 风险目标：基础等风险；亦可设置风险预算（如股票合计贡献 50%、债券 30%、黄金 20%），我可扩展为“风险预算”版本。
下一步

- 如果你提供四个具体可交易 ETF 的代码与数据源偏好（境内/境外），我将把脚本改为自动抓取真实行情、计算滚动协方差与权重，并输出可执行的每月再平衡指令或订单文件。



总评

- 思路基本正确：以协方差衡量风险、用 SLSQP 最小化风险贡献差距并加权约束，配合滚动窗口与月度再平衡，能落地一个可用的风险平价框架。
- 适合数据驱动的组合管理，但在协方差估计、约束设计、交易执行与鲁棒性方面仍有提升空间，建议做几处关键改造以提高稳定性和可执行性。
主要优点

- 结构完整：数据抓取、权重优化、回测与可视化都有，实现闭环管理。
- 约束合理：非负、权重和为 1、并设置 5%–50% 上下限，能抑制单资产过度集中。
- 风险贡献目标明确：采用“各资产风险贡献占比相等”作为目标，符合风险平价常见实践。
- 再平衡机制清晰：月度/季度调仓和偏离触发式调仓都给出，便于控制成本与周转。
关键问题与改进点

- 协方差计算函数不一致且可能错误：
  - A) 中的 calculate_covariance_matrix 用 returns.rolling(window).cov() 并 iloc[-len(returns.columns):, :] 截取，滚动协方差返回多层索引，该截取方式风险很高且不必要。
  - 实际 B/C 中你又改为 recent_returns.cov() * 252 ，这才是干净的做法。建议删除 A) 的函数，统一使用： returns.tail(window).cov() * 252 。
- 目标函数的规范化逻辑需说明：
  - 你计算的贡献 contrib = w_i * (Σw)_i / σ_p ，再用 contrib / contrib.sum() 与均等向量比较，本质上是在等化“方差贡献占比”（因 contrib.sum() = σ_p ）。这是常用的 ERC 变体，没问题，但最好在注释中明确“等化的是方差贡献占比”，避免与“等化波动贡献”混淆。
- 数据质量与标的选择：
  - yfinance 的中国标的（如 000300.SS ）在国内网络下可能不稳定，且 ETF 最好用“复权/调整收盘价（Adj Close）”以包含分红影响。建议改为读取 Adj Close 或本地 CSV，或增加重试/缓存。
- 数值稳定性：
  - 协方差在样本不足或资产高度相关时可能病态，建议加入收缩（例如 Ledoit–Wolf）或对角线平滑（ Σ ← (1−α)Σ + α·diag(Σ) ），提升优化稳定性。
  - 优化器可能遇到不可行或收敛慢的情况，建议加“失败回退”为逆波动率权重。
- 回测细节：
  - 早期缺数据时以 0 代替收益会扭曲曲线，可选择跳过或前移权重生效日。
  - 没有交易成本与滑点，绩效指标可能偏高。可按固定 bps 或百分比扣减再平衡日收益。
- 约束与周转控制：
  - 固定 5%–50% 下限在极端条件下可能阻碍风险平价（例如某资产波动极高仍被强制纳入 5%），建议把下限作为软约束或将其设为更低值（如 0–50%），并加入“周转惩罚项”（权重变化的 L1/L2）以减少交易。
与我实现的对比

- 我在 risk_parity.py:58 用迭代缩放法等化风险贡献，依赖少、数值稳健，适合生产落地；你用 SLSQP 目标优化，约束灵活、更通用，但依赖 scipy 且对协方差质量更敏感。
- 我示例里暂用合成数据并提供“最小依赖”的权重求解；你的版本直接集成行情抓取、回测和可视化，框架更完整。两者可结合：保留你完整框架，同时将权重求解模块替换为更稳健的迭代 ERC 或加上协方差收缩。
实操建议

- 统一协方差计算： cov = returns.tail(lookback).cov() * 252 ，删除滚动协方差的复杂切片。
- 收益处理：优先用对数收益（ np.log(price).diff() ），并 dropna(how='any') 保证资产对齐。
- 协方差收缩：加入简单收缩参数 alpha （如 0.1），对角线平滑，提升稳定性。
- 约束与交易：
  - 调整下限到 0 或 1%，并用“目标权重+周转惩罚”的复合目标，兼顾平衡与交易成本。
  - 再平衡采用“偏离阈值 + 定期”，减少不必要交易。
- 指标与可视化：用 Adj Close 代替 Close ，并在报告里同步输出“风险贡献”的饼图与“偏离建议”。
下一步

- 如果你希望把这个实现直接升级到可跑的“真实行情 + 稳健求解 + 周转控制”，我可以在现有仓库里：
  - 保留你框架结构，替换权重求解为迭代 ERC（或加入 Ledoit–Wolf 收缩）；
  - 支持本地 CSV 或 yfinance 双路径，优先读取 Adj Close ；
  - 加“周转惩罚 + 偏离阈值”再平衡；并输出每月 JSON 权重文件用于执行。
- 你只需确认四个具体可交易 ETF 的代码（境内/境外）与数据源偏好，我会直接改好并验证运行。


已为你接入并运行

- 使用你提供的四个标的： 511090.SH 、 512890.SH 、 518880.SH 、 159659.SZ 。
- 脚本现在支持从 Yahoo 下载这些标的的历史日收盘（用 Adj Close ），计算对数收益，取近一年（252 个交易日）协方差并求风险平价权重。
- 运行命令： python3 risk_parity.py --source yahoo --tickers 511090.SH 512890.SH 518880.SH 159659.SZ
- 输出示例（会随最新数据变化）： {"weights": {"511090.SH": 0.2565, "512890.SH": 0.4450, "518880.SH": 0.1416, "159659.SZ": 0.1569}}
使用方法

- 实时计算：运行上面的命令即可按最新数据计算权重。
- 调整窗口：通过代码中的 lookback_days （当前默认 252）控制使用的历史长度。
- 说明：沪深交易所代码会自动映射到 Yahoo 的后缀规则（ .SH → .SS ， .SZ 保持不变）。
定期更新

- 月度更新（macOS）：将如下条目加入 crontab ，每月 1 日 09:00 重新计算并记录日志。
- 命令： 0 9 1 * * cd /Users/bytedance/sourcetree/RiskParity && /usr/bin/python3 risk_parity.py --source yahoo --tickers 511090.SH 512890.SH 518880.SH 159659.SZ >> weights.log 2>&1
- 如需输出到 JSON 文件以便执行调仓，我可以把打印替换为写入 weights-YYYYMM.json 。
实现细节

- 数据抓取：构造 Yahoo 历史 CSV 下载链接，取 Adj Close ，统一为对数收益。
- 日期对齐：对四个标的的共同交易日做交集对齐，避免缺值影响协方差。
- 风险平价：在 risk_parity.py:58 等化风险贡献的迭代算法，非负约束且权重归一化。
- 代码入口：命令行参数在 risk_parity.py:130 ；Yahoo 抓取与对齐在 risk_parity.py:100–129 。
建议参数与注意

- 窗口长度：252（日）较稳健；也可用 126 提升灵敏度或 504 提高稳定性。
- 指标含义：权重越高并不代表预期收益高，而是为平衡风险贡献；权重倾向分配到低波动、低相关的资产。
- 风险与交易：可加入再平衡阈值（如相对偏差 20%）来控制交易频率；需要我可加上“周转惩罚 + 交易成本”模块。
如果你希望把当前权重保存为文件、或增加回测和监控报告功能，我可以直接把这些能力加进脚本并验证运行。

